{% load static %}

{% include 'DMSApp/Komponen/navbar.html' %}
      <!-- partial -->
      <div class="main-panel">
        <div class="content-wrapper">
          <div class="row">
            <div class="col-md-12 grid-margin">
              <div class="row">
                <div class="col-6 col-xl-6 mb-4 mb-xl-0">
                    <h3 class="font-weight-bold">Document Management System</h3>
                    <!-- <h6 class="font-weight-normal mb-0">Monitored, <span class="text-primary">{{ running_mesin_count }} machines</span> are running smoothly! {% if not_running_mesin_count %}You have<code>{{ not_running_mesin_count }} not running! {% endif %}</code></h6>
                    --></div>
                <!-- <div class="col-6 col-xl-6 mb-4 mb-xl-0">
                    <h3 class="font-weight-bold">Andon Machine</h3>
                    <h6 class="font-weight-normal mb-0">All systems are running smoothly! You have <span class="text-primary">3 unread alerts!</span></h6>
                </div> -->
              </div>            
            </div>
          </div>

          <!-- Card M/C -->
          <div class="row">
            {% for key, value in options_jenis_mesin.items %}
            <div class="col-md-6 grid-margin transparent">
              <div class="row">
                {% for obj in objects %}
                  {% if obj.jenis_mesin == key %}
                  <div class="col-md-6 mb-4 stretch-card transparent">
                    <div class="{% if obj.is_active %}card {{ value.color }}{% else %}card card-inverse-dark border-0{% endif %} {% if not obj.is_running %} card-light-danger blink {% endif %}" {% if obj.is_active %}data-toggle="modal"{% endif %}
                    {% if obj.is_running %} data-target="#mod0-{{ obj.no_mesin }}"
                      {% else %} data-target="#mod1-{{ obj.no_mesin }}" {% endif %}>
                      <div class="card-body">
                        <p class="mb-4">Number of Machine</p>
                        <p class="fs-30 mb-2">{{ obj.no_mesin|upper|slice:"4:" }}</p>
                        <p>{{ obj.jenis_mesin|upper }}</p>
                      </div>
                    </div>
                  </div>
                  {% endif %}
                {% endfor %}
              </div>
            </div>
            {% endfor %}

            <!-- Modal start downtime -->
            {% for obj in objects %}
            <div class="modal fade" id="mod0-{{ obj.no_mesin }}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel" style="display: flex; align-items: center;">
                      <i class="mdi mdi-alert-circle mdi-24px text-danger mr-2"></i>
                      downtime mesin
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <h3><b>M/C {{ obj.jenis_mesin|capfirst }} {{ obj.no_mesin|upper|slice:"4:" }}</b></h4>Terjadi masalah, hubungi <b>Setter</b>?
                  </div>
                  <div class="modal-footer">
                    <form method="POST" action="{% url 'running_mesin' pk=obj.no_mesin %}" enctype="multipart/form-data">
                      {% csrf_token %}
                      <input type="hidden" value="stop_run" name="is_running" />
                      <input class="btn btn-primary" type="submit" value="Yes">
                    </form>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                  </div>
                </div>
              </div>
            </div>
            
            <!-- Modal finish downtime -->
            <div class="modal fade" id="mod1-{{ obj.no_mesin }}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
              <div class="modal-dialog modal-dialog-centered" role="document">
                <div class="modal-content">
                  <div class="modal-header">
                    <h5 class="modal-title" id="exampleModalLabel" style="display: flex; align-items: center;">
                      <i class=" mdi mdi-help-circle mdi-24px text-primary mr-2"></i>
                      uptime mesin?
                    </h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                      <span aria-hidden="true">&times;</span>
                    </button>
                  </div>
                  <div class="modal-body">
                    <h3><b>M/C {{ obj.jenis_mesin|capfirst }} {{ obj.no_mesin|upper|slice:"4:" }}</b></h4>masalah selesai?<br>
                  </div>
                  <div class="modal-footer">
                    <form method="POST" action="{% url 'running_mesin' pk=obj.no_mesin %}" enctype="multipart/form-data">
                      {% csrf_token %}
                      <input type="hidden" name="is_running" />
                      <input class="btn btn-primary" type="submit" value="Yes">
                    </form>
                    <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                  </div>
                </div>
              </div>
            </div>
            {% endfor %}
          </div>

          <div class="row">
            <div class="col-lg-12 grid-margin stretch-card">
              <div class="card">
                <div class="card-body">
                  <h4 class="card-title">Status Downtime Machine</h4>
                  <p class="card-description">
                    Add class <code>.table-striped</code>
                  </p>
                  <div class="table-responsive">
                    <table class="table table-striped table-hover">
                      <thead>
                        <tr>
                          <th>#</th>
                          <th>No. Machine</th>
                          <th>Start Date</th>
                          <th>Start Time</th>
                          <th>Resolved Date</th>
                          <th>Resolved Time</th>
                          <th>Duration</th>
                          <th>Status</th>
                          <th>Action</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for dt in objects_dt %}
                        <tr>
                          <td>{{ forloop.counter }}</td>
                          <td>{{ dt.mesin.jenis_mesin|capfirst }} {{ dt.mesin.no_mesin|upper|slice:"4:" }}</td>
                          <td>{{ dt.mdt_start_time|date:"d-m-Y" }}</td>
                          <td>{{ dt.mdt_start_time|time:"H:i:s" }}</td>
                          <td>{% if dt.mdt_end_time %}
                            {{ dt.mdt_end_time|date:"d-m-Y" }}
                            {% else %}
                            No end date available
                            {% endif %}
                          </td>
                          <td>{% if dt.mdt_end_time %}
                            {{ dt.mdt_end_time|time:"H:i:s" }}
                            {% else %}
                            No end time available
                            {% endif %}
                          </td>
                          <td>{% if dt.mdt_end_time %}
                            {{ dt.downtime_formatted }}
                            {% else %}
                            <span class="text-danger" id="running-time-{{ dt.id }}"></span>
                            {% endif %}
                          </td>
                          <td>
                            <button data-toggle="modal" data-target="#down0-{{ dt.id }}" data-dismiss="modal" type="button" class="btn {% if dt.mdt_end_time %}btn-success{% else %}btn-danger blink{% endif %} btn-sm">
                              {% if dt.mdt_end_time %}Solved{% else %}Pending{% endif %}
                            </button>
                          </td>
                          <script>
                            var startTime{{ dt.id }} = new Date("{{ dt.mdt_start_time|date:'c' }}");  // Ensure start_time is in a valid JavaScript date format
                            setInterval(function() {
                                var currentTime = new Date();
                                var elapsedTime = currentTime - startTime{{ dt.id }};
                                var days = Math.floor(elapsedTime / (1000 * 60 * 60 * 24));
                                var remainingTime = elapsedTime % (1000 * 60 * 60 * 24);
                                var hours = Math.floor(remainingTime / (1000 * 60 * 60));
                                var remainingTime = remainingTime % (1000 * 60 * 60);
                                var minutes = Math.floor(remainingTime / (1000 * 60));
                                var seconds = Math.floor((remainingTime % (1000 * 60)) / 1000);
                                var formattedTime = days + ' days, ' + hours.toString().padStart(2, '0') + ':' + minutes.toString().padStart(2, '0') + ':' + seconds.toString().padStart(2, '0');
        
                                document.getElementById('running-time-{{ dt.id }}').textContent = formattedTime;
                            }, 1000);
                          </script>
                          <td class="no-blink">{% if not dt.mdt_end_time %}
                            <button data-toggle="modal" data-target="#down1-{{ dt.id }}" data-dismiss="modal" type="button" class="btn btn-warning btn-sm">Take</button>{% endif %}
                          </td>
                        </tr>

                        <!-- Modal downtime departemen new -->
                        <div class="modal fade" id="down1-{{ dt.id }}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                          <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel" style="display: flex; align-items: center;">
                                  <i class=" mdi mdi-help-circle mdi-24px text-primary mr-2"></i>
                                    M/C {{ dt.mesin.jenis_mesin|capfirst }} {{ dt.mesin_id|upper|slice:"4:" }}
                                </h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                    <span aria-hidden="true">&times;</span>
                                </button>
                              </div>
                              <div class="modal-body">
                                {% for dept in objects_dept %}
                                <div class="row mb-2">
                                  <div class="col-md-4">
                                    <form method="POST" action="{% url 'repair_mesin' pk=dt.id %}" enctype="multipart/form-data">
                                      {% csrf_token %}
                                      <input type="hidden" value="call" name="set" />
                                      <input type="hidden" value="{{ dept.nm_departemen }}" name="dept" />
                                      <input type="submit" value="{{ dept.nm_departemen|upper }}" class="btn btn-primary btn-lg btn-block"
                                      {% for dt_dept in objects_dept_dt %}
                                      {% if dt_dept.mesin_dt_id == dt.id and dt_dept.waiting_departemen_id == dept.id and dt_dept.is_waiting %}
                                      disabled
                                      {% endif %}
                                      {% if dt_dept.mesin_dt_id == dt.id and dt_dept.waiting_departemen_id == dept.id and dt_dept.ddt_start_time %}
                                      disabled
                                      {% endif %}
                                      {% endfor %}>
                                    </form>
                                  </div>
                                  
                                  {% for dt_dept in objects_dept_dt %}
                                  {% if dt_dept.mesin_dt_id == dt.id and dt_dept.waiting_departemen_id == dept.id %}
                                  <div class="col-md-4">
                                    <form method="POST" action="{% url 'repair_mesin' pk=dt.id %}" enctype="multipart/form-data">
                                      {% csrf_token %}
                                      <input type="hidden" value="start" name="set" />
                                      <input type="hidden" value="{{ dept.nm_departemen }}" name="dept" />
                                      <input class="btn btn-warning btn-lg btn-block" type="submit" value="Start"
                                      {% for dt_dept in objects_dept_dt %}
                                      {% if dt_dept.mesin_dt_id == dt.id and dt_dept.waiting_departemen_id == dept.id and dt_dept.ddt_start_time %}
                                      disabled
                                      {% endif %}
                                      {% if dt_dept.mesin_dt_id == dt.id and dt_dept.waiting_departemen_id == dept.id and dt_dept.ddt_start_time and dt_dept.ddt_end_time %}
                                      disabled
                                      {% endif %}
                                      {% endfor %}>
                                    </form>
                                  </div>
                                  {% endif %}
                                  {% endfor %}

                                  {% for dt_dept in objects_dept_dt %}
                                  {% if dt_dept.mesin_dt_id == dt.id and dt_dept.waiting_departemen_id == dept.id %}
                                  <div class="col-md-4">
                                    <form method="POST" action="{% url 'repair_mesin' pk=dt.id %}" enctype="multipart/form-data">
                                      {% csrf_token %}
                                      <input type="hidden" value="finish" name="set" />
                                      <input type="hidden" value="{{ dept.nm_departemen }}" name="dept" />
                                      <input class="btn btn-success btn-lg btn-block" type="submit" value="Selesai"
                                      {% for dt_dept in objects_dept_dt %}
                                      {% if dt_dept.mesin_dt_id == dt.id and dt_dept.waiting_departemen_id == dept.id and dt_dept.is_waiting %}
                                      disabled
                                      {% endif %}
                                      {% if dt_dept.mesin_dt_id == dt.id and dt_dept.waiting_departemen_id == dept.id and dt_dept.ddt_start_time and dt_dept.ddt_end_time %}
                                      disabled
                                      {% endif %}
                                      {% endfor %}>
                                    </form>
                                  </div>
                                  {% endif %}
                                  {% endfor %}


                                </div>
                                {% endfor %}
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                              </div>
                            </div>
                          </div>
                        </div>

                        <!-- Modal end downtime -->
                        <div class="modal fade" id="down0-{{ dt.id }}" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
                          <div class="modal-dialog modal-dialog-centered modal-xl" role="document">
                            <div class="modal-content">
                              <div class="modal-header">
                                <h5 class="modal-title" id="exampleModalLabel" style="display: flex; align-items: center;">
                                  <i class="mdi mdi-timer mdi-24px text-primary mr-2"></i>
                                  <b>detail M/C {{ dt.mesin.jenis_mesin|capfirst }} {{ dt.mesin_id|upper|slice:"4:" }}</b>
                                </h5>
                                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                                  <span aria-hidden="true">&times;</span>
                                </button>
                              </div>
                              <div class="modal-body">
                                <div class="row">
                                  <div class="col-md-12">
                                    <div class="row font-weight-bold">
                                      <div class="col">Departemen</div>
                                      <div class="col">Start Waiting</div>
                                      <div class="col">Start</div>
                                      <div class="col">Finish</div>
                                      <div class="col">Duration</div>
                                    </div>
                                </div>
                                  {% for dt_dept in objects_dept_dt %}
                                  {% if dt_dept.mesin_dt_id == dt.id %}
                                  <div class="col-md-12">
                                      <div class="row">
                                        <div class="col">{{ dt_dept.waiting_departemen.nm_departemen|capfirst }}</div>
                                        <div class="col">{{ dt_dept.waiting_time|date:"d-m-Y" }} {{ dt_dept.waiting_time|time:"H:i:s" }}</div>
                                        <div class="col">{{ dt_dept.ddt_start_time|date:"d-m-Y" }} {{ dt_dept.ddt_start_time|time:"H:i:s" }}</div>
                                        <div class="col">{{ dt_dept.ddt_end_time|date:"d-m-Y" }} {{ dt_dept.ddt_end_time|time:"H:i:s" }}</div>
                                        <div class="col">{{ dt_dept.dept_dt_formatted }}</div>
                                      </div>
                                  </div>
                                  {% endif %}
                                  {% endfor %}
                                </div>
                              </div>
                              <div class="modal-footer">
                                <button type="button" class="btn btn-danger" data-dismiss="modal">Close</button>
                              </div>
                            </div>
                          </div>
                        </div>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-4 stretch-card grid-margin">
              <div class="card">
                <div class="card-body">
                  <p class="card-title">notifications</p>
                  <ul class="icon-data-list">
                    {% for notif in notifications %}
                    <li>
                      <div class="d-flex">
                        {% if notif.status_running %}
                        <img src="{% static 'images/faces/info-1.png' %}">
                        {% else %}
                        <img src="{% static 'images/faces/info-0.png' %}">
                        {% endif %}
                        <div>
                          <p class="text-info mb-1">{{ notif.mesin.jenis_mesin|capfirst }} {{ notif.mesin_id|upper|slice:"4:" }}</p>
                          <p class="mb-0">{{ notif.pesan|capfirst }}</p>
                          <small>{{ notif.time_stamp|time:"H:i" }}</small>
                        </div>
                      </div>
                    </li>
                    {% endfor %}
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
        {% include 'DMSApp/Komponen/footer.html' %}